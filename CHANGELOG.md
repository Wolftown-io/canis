# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Roadmap Alignment
- Current roadmap phase: Phase 6 (Competitive Differentiators & Mastery) - In Progress
- Roadmap last updated: 2026-02-27

### Milestone Metadata
- Milestone: Phase 6 - Competitive Differentiators & Mastery
- Release note structure source: `docs/project/RELEASE_NOTES_TEMPLATE.md`

### Added
- Added 13 new observability metrics: HTTP errors, WebSocket connections/messages, voice sessions/duration/RTP, DB pool stats, auth token refresh, process memory, OTel export failures (#285)
- Added admin RLS bypass for `connection_metrics` and `connection_sessions` tables for Command Center aggregate queries (#285)
- Focus modes for intelligent notification routing â€” suppress notifications during gaming, coding, or streaming sessions with VIP contact overrides and emergency keyword bypass (#253)
- Auto-activation of focus modes when matching apps are detected (games, IDEs) with support for custom triggers (#253)
- Focus settings UI with per-mode configuration: suppression level, VIP users/channels, emergency keywords, and trigger categories (#253)

### Changed
- Renamed `kaiku_auth_attempts_total` metric to `kaiku_auth_login_attempts_total` to match observability contract (#285)
- Fixed voice join metric to use `outcome` label (was `result`) with `failure` value (was `error`) (#285)

### Fixed
- Process scanner now reports correct activity type (coding, listening, watching) instead of hardcoding all detected apps as "game" (#253)

### Security
- Channel creation, member operations, and file uploads now enforce guild membership and permission checks â€” previously these endpoints could be accessed without proper authorization (#217, #218)
- Guild join endpoint now requires a valid invite â€” previously any authenticated user could join any guild directly (#219)
- E2EE device registration is now limited to 10 devices per user to prevent ghost device attacks (#221)
- E2EE identity key fallback that produced permanently undecryptable messages has been replaced with a proper error â€” clients now surface a clear re-verification prompt instead of silently losing messages (#222)
- Logout now verifies refresh token ownership â€” previously any valid token could revoke another user's session (#224)
- MFA setup now requires TOTP verification before activation â€” previously MFA was activated immediately on secret generation without confirming the user had configured their authenticator (#225)
- E2EE local key store is now encrypted with AES-256-GCM using SQLCipher â€” previously session data was stored in plaintext SQLite (#226)
- Server now validates uploaded E2EE public keys are valid Curve25519 points â€” previously any byte string was accepted (#227)
- E2EE key backup overwrites now require password re-authentication â€” previously backups could be silently replaced (#228)
- Guild admins can now manage custom emoji regardless of uploader â€” previously only the original uploader could update or delete emoji (#229)
- Webhook delivery now resolves DNS and validates the target IP at delivery time to prevent SSRF via DNS rebinding (#230)
- Webhook signing secrets are now encrypted at rest using AES-256-GCM â€” previously stored as plaintext in the database (#231)
- Refresh token rotation now uses atomic database operations to prevent race condition token reuse (#232)
- E2EE local key store encryption now uses Argon2id key derivation instead of single-pass SHA-256 (#233)

### Fixed
- WebSocket pubsub handler no longer panics when filtering events from blocked users â€” `blocking_read()` was incorrectly used in an async context, crashing the server whenever a blocked user's event was processed (#212)
- Redis failures in block checks and screen share limits are now logged with user context and failsafe policy â€” previously errors were silently swallowed, making Redis outages invisible in call, DM, message, and friend request flows (#213)
- Tauri IPC crypto commands now validate string parameter lengths â€” previously unbounded inputs to `init_e2ee`, `encrypt_message`, `decrypt_message`, `create_backup`, `restore_backup`, and `generate_prekeys` could cause CPU stalls or excessive memory usage (#214)
- Admin dashboard now correctly shows whether the current session is elevated â€” previously `is_elevated` was always reported as `false` regardless of actual elevation state (TD-17)
- Revealed spoilers now stay revealed when scrolling away and back in the message list â€” previously clicking `||spoiler||` text to reveal it would reset when the message re-rendered (TD-22)
- E2EE key backups now include the actual identity keys and prekeys â€” previously the encrypted backup contained only a timestamp placeholder, making it impossible to restore E2EE keys from a backup
- WebSocket upgrade error paths no longer panic on unexpected conditions â€” replaced `.expect()` calls with a proper `error_response` helper that returns HTTP status codes (TD-05)

### Changed
- Message character limits are now evaluated dynamically: standard text is limited to 4,000 characters, while messages containing code blocks can have up to 10,000 total characters.
- Upload size limits (avatar, emoji, attachment) are now fetched from `GET /api/config/upload-limits` at startup and applied client-side â€” previously the client used hardcoded defaults that could drift from server configuration (TD-13)
- Notification sounds now play for the active channel when the application window is in the background
- Production client builds now selectively strip `console.log` and `console.debug` while preserving `console.error` and `console.warn` for diagnostics (TD-09)

### Added
- Digital Library â€” guild pages now support revision history (automatic snapshots on content changes with configurable pruning), page categories (guild-scoped, ordered, with CRUD and reordering), deep-linkable heading anchors (GitHub-style slugs with click-to-copy URL), a library catalog view for browsing pages by category, and per-guild configurable page/revision limits with admin overrides; 13 new API endpoints for revisions, categories, and admin limit management
- Personal workspaces â€” users can create named workspace folders and add channels from any guild they're a member of, enabling cross-guild "Mission Control" views; 9 REST API endpoints for workspace CRUD, entry management, and drag-and-drop reordering; real-time cross-device sync via 7 new WebSocket events; configurable max workspaces per user limit (default: 20); guild membership and VIEW_CHANNEL permission checks enforced on entry creation
- Data export â€” users can request a full export of their data (profile, messages, guild memberships, friends, preferences) as a downloadable ZIP archive via `POST /api/me/data-export`; background worker gathers data into a versioned JSON archive, uploads to S3, and sends email notification when ready; downloads expire after 7 days
- Account deletion with 30-day grace period â€” users can request account deletion via `POST /api/me/delete-account` (requires password confirmation); deletion is scheduled 30 days out and can be cancelled via `POST /api/me/delete-account/cancel`; after the grace period, the account is permanently deleted with messages anonymized (author removed but content preserved); guild ownership must be transferred before deletion
- User profile now includes `deletion_scheduled_at` field when account deletion is pending, allowing clients to display a cancellation banner
- Progressive image loading with blurhash placeholders â€” uploaded images are processed to generate blurhash color previews, thumbnail (256px) and medium (1024px) WebP variants; client displays instant blurhash placeholder while thumbnail loads, with smooth fade-in transition; click opens full-resolution original; aspect-ratio CSS prevents layout shift during load
- Image variant download support â€” `GET /api/messages/attachments/{id}/download?variant=thumbnail|medium` serves bandwidth-efficient WebP variants with graceful fallback to original when variants are unavailable
- Guild resource limits â€” configurable per-instance limits for guilds per user, members, channels, roles, emojis, bots per guild, and webhooks per app; enforced server-side with `LIMIT_EXCEEDED` (403) errors; limits configurable via environment variables (`MAX_GUILDS_PER_USER`, `MAX_MEMBERS_PER_GUILD`, etc.) with sensible defaults
- Guild usage stats endpoint (`GET /api/guilds/{id}/usage`) â€” shows current resource counts vs limits for members, channels, roles, emojis, and bots; requires guild membership
- Instance limits endpoint (`GET /api/config/limits`) â€” public endpoint returning all configured resource limits for client display
- Guild plan column â€” `plan` field on guilds (default: "free") preparing for future tier/boost system
- Usage tab in guild settings â€” visual progress bars showing resource usage with color-coded thresholds (green/yellow/red) and plan badge
- Guild discovery â€” public browsing of discoverable guilds with full-text search, tag filtering, and sort by popularity or newest; guilds opt in via a new "Discoverable" toggle in Server Settings with up to 5 tags and an optional banner URL; unauthenticated users can browse, authenticated users can join directly without an invite code; controlled by `ENABLE_GUILD_DISCOVERY` server config
- Guild discovery frontend UI backfill â€” added dedicated discovery cards/listing, search and sort controls, and discoverable guild settings controls in the client experience (#271)
- Onboarding wizard â€” 5-step first-time experience for new users: display name, theme selection with live preview, microphone/speaker setup, server discovery or invite code join, and welcome summary; skippable at any step; re-triggerable from Appearance Settings
- Interactive API documentation (Swagger UI) at `/api/docs` â€” covers all REST endpoints with schemas, auth requirements, and tag grouping. Controlled via `ENABLE_API_DOCS` env var.
- Webhook system for bot applications â€” developers can register up to 5 webhook endpoints per application to receive HTTP POST notifications for `message.created`, `member.joined`, `member.left`, and `command.invoked` events with HMAC-SHA256 signed payloads, automatic retry with exponential backoff (5 attempts), dead-letter storage for failed deliveries, and a delivery log for debugging
- Bot gateway intents â€” bot applications can declare `messages`, `members`, and `commands` intents to filter which events they receive over the WebSocket gateway; `commands` is always enabled by default for backward compatibility
- `MemberJoined` and `MemberLeft` gateway events â€” bots with the `members` intent now receive real-time notifications when users join, leave, or are kicked from guilds the bot is installed in
- Webhook management UI â€” per-application webhook configuration page with create/edit/delete, event type selection, test ping, signing secret display (shown once on creation), and delivery log viewer
- Guild content safety filters â€” guild managers can enable built-in filter categories (Slurs, Hate Speech, Spam, Abusive Language) or add custom keyword/regex patterns to automatically block, log, or warn on matching messages; includes dry-run test panel, paginated moderation log, and new Safety tab in Server Settings
  - Filters apply to guild text messages only; encrypted messages and DMs are not inspected
  - Uses Aho-Corasick for fast keyword matching + compiled regex for pattern rules
  - Per-guild filter engines are lazily cached and invalidated on config changes
  - Admin notification via `admin_moderation_blocked` WebSocket event when messages are blocked
  - All config changes logged to the system audit log
- MFA backup codes â€” users with MFA enabled can generate 10 one-time recovery codes (`POST /api/auth/mfa/backup-codes`) to regain account access if their authenticator app is unavailable; each code is single-use and hashed with Argon2id at rest
- MFA client UI â€” full MFA setup wizard in Security Settings with QR code display, TOTP verification, and automatic backup code generation on first verify; MFA code input step during login when MFA is enabled; remaining backup code count display; regenerate backup codes with copy-all and download-as-txt buttons; disable MFA with code confirmation (#170)
- MFA backup code count endpoint (`GET /auth/mfa/backup-codes/count`) â€” returns remaining and total backup code counts for the authenticated user
- Virtualized guild member list, DM conversation sidebar, and search results using `@tanstack/solid-virtual` for smooth scrolling with large datasets
- Toast usage convention documentation with type/duration table and deduplication guidance
- Built-in `/ping` command for smoke testing â€” responds with "Pong!" and server-side latency in any guild channel without bot installation
- Command response delivery â€” bot slash command responses now reach the invoking user via WebSocket relay; non-ephemeral responses become persistent chat messages, ephemeral responses are shown only to the invoker
- 30-second timeout notification when bots don't respond to slash commands
- Structured bot gateway error events (`invalid_json`, `handler_error`) â€” bots now receive programmatic feedback on failures
- Example Python bot script (`docs/examples/ping-bot.py`) demonstrating full bot lifecycle
- Lazy loading for admin, settings, guild settings, voice, and screen share components â€” reduces initial bundle by code-splitting 17 components into separate chunks loaded on demand (#168)
- Settings and category collapse state now persist across Tauri app restarts â€” audio, voice, theme, and notification preferences saved to `settings.json`, category expand/collapse state saved to `ui_state.json` in the app data directory (#172)
- HTTP integration tests for chat module â€” 19 tests across channels CRUD, messages CRUD, DM operations, and upload error paths (`channels_http_test.rs`, `messages_http_test.rs`, `dm_http_test.rs`, `uploads_http_test.rs`) (#164)
- Comprehensive Playwright E2E test suite covering 68 UI items across 12 spec files â€” Auth, Navigation, Messaging, Guild, Channels, Friends/DMs, Settings, Voice, Admin, Search, and Permissions with shared test helpers and coverage tracker (`docs/testing/ui-coverage.md`)
- Visual mention highlighting â€” `@everyone`, `@here`, and `@username` mentions render with accent-colored background styling
- "Mark All as Read" bulk actions â€” mark all channels in a guild, all DMs, or everything as read at once
- Per-guild thread toggle â€” guild managers can enable/disable message threads from Server Settings > General
- Error toast notifications for user-initiated actions that previously failed silently (friend requests, message send/edit/delete, thread replies, favorites, categories)
- Relevance-ranked search results using PostgreSQL `ts_rank` with sort toggle (Relevance / Date)
- Server-side search snippet highlighting using PostgreSQL `ts_headline` with `<mark>` tags
- Global search across all guilds and DMs (`GET /api/search`, Ctrl+Shift+F shortcut)
- "Search Everywhere" command in Command Palette (Ctrl+K)
- Search syntax help tooltip showing AND, OR, "exact phrase", and -exclude operators
- Native webcam capture pipeline for Tauri desktop client using `nokhwa` (camera enumeration, RGBâ†’I420 conversion, VP9 encoding, RTP sending)
- Webcam video support in voice channels with camera toggle button
- Simultaneous webcam and screen sharing (multi-stream)
- Dynamic track add/remove with SFU renegotiation mid-session
- Track source identification via pending source queue (Webcam vs ScreenVideo)
- Advanced message search with filters (date range, channel, author, has:link, has:file)
- DM message search endpoint (`GET /api/dm/search`) with the same filter support
- DM search UI accessible from the home sidebar
- Dedicated Search rate limit category (15 req/min) to prevent abuse
- Bot ecosystem infrastructure (Phase 5)
  - Database schema for bot users, applications, and slash commands
  - Bot application management API (create, list, get, delete)
  - Bot user creation with secure token generation (Argon2id)
  - Token reset functionality for bot applications
  - Guild bot installation tracking
  - Support for guild-specific and global slash commands
  - Slash command registration and management API
  - Command validation (name format, description length)
  - Bulk command registration with transactional updates
  - Bot gateway WebSocket endpoint (`/api/gateway/bot`)
  - Bot token authentication for gateway connections
  - Separate event system for bots (CommandInvoked, MessageCreated, GuildJoined/Left)
  - Redis pub/sub on `bot:{bot_id}` channels for bot-specific events
  - Slash command invocation routing from `/command` chat input to installed bots
  - Guild bot install endpoint for admins (`POST /api/guilds/{id}/bots/{bot_id}/add`)
  - Comprehensive integration tests (14 tests covering applications, commands, auth, ownership)
  - Bot applications management UI in settings
  - API client library for bot operations (applications, commands, tokens)
  - Token display modal with copy functionality and security warnings
  - Application CRUD interface with validation
  - Slash command management UI (register, view, delete commands with options)
  - Bot message sending with channel membership authorization
  - Command response handling with Redis storage and 5-minute TTL
  - Input validation for bot messages and command responses (1-4000 characters)
  - Developer documentation for the bot system (`docs/development/bot-system.md`)
  - Guild bot management UI in server settings (list installed bots, remove bots)
  - Guild bot list and remove API endpoints (`GET/DELETE /api/guilds/{id}/bots`)
- Slack-style message threads for organized side-discussions
  - Thread replies appear in a sidebar panel, keeping the main channel feed clean
  - Thread indicators show reply count and last reply time on parent messages
  - "Reply in Thread" action in message context menu and hover toolbar
  - Per-thread read tracking with real-time WebSocket updates
- Full WebSocket event parity for Tauri desktop client (#132)
  - Admin events (ban/unban, suspend/unsuspend, reports) now received in desktop app
  - Friend request and block events now received in desktop app
  - Voice stats, preferences sync, and state patch events now received in desktop app
  - Screen share events now have Tauri listeners (Rust enum already existed)
- Delete user option in admin panel with confirmation dialog (#147)
- Delete guild option in admin panel with confirmation dialog (#148)
- Virtual scrolling for message lists using `@tanstack/solid-virtual`
  - Only ~30 DOM nodes rendered regardless of message count (previously all messages in DOM)
  - Smart height estimation based on message content (images, code blocks, reactions)
  - Handles 10,000+ message histories efficiently
- Infinite scroll pagination: scroll to top to load older messages automatically
  - IntersectionObserver-based sentinel with scroll position preservation
  - "Beginning of conversation" marker when full history is loaded
- Configurable memory eviction for message history (default: 2000 messages per channel)
  - Drops messages far from viewport, re-fetches on scroll back
- Message input enhancements for improved UX
  - Multi-line textarea with auto-resize (min 1 line, max 8 lines)
  - Shift+Enter for newlines, Enter to send
  - IME composition support for CJK input (Chinese, Japanese, Korean)
  - Persistent drafts with localStorage (auto-saves every 300ms, max 50 drafts with LRU eviction)
  - Drafts skip E2EE channels to prevent plaintext leaks
  - Proper cleanup of draft event listeners on logout to prevent memory leaks
  - Graceful localStorage quota exceeded handling (auto-reduces to 25 drafts and retries)
  - Quick message actions toolbar (hover to reveal: 4 quick emojis + emoji picker + context menu)
  - @user autocomplete with arrow key navigation (works in both guild channels and DMs)
  - Prefix matches prioritized in autocomplete results for better relevance
  - :emoji: autocomplete with support for both standard and custom guild emojis
  - False positive prevention for autocomplete (ignores email addresses, times, URLs)
  - Smart positioning for autocomplete popup using floating-ui with autoUpdate
  - Autocomplete closes when clicking away from trigger in textarea
  - Full ARIA support for autocomplete popup (role="listbox", aria-activedescendant, aria-selected)
  - ARIA labels for all message action buttons (emoji reactions, picker, context menu)
- Channel-level permission system (VIEW_CHANNEL)
  - New VIEW_CHANNEL permission bit (bit 24) controls channel visibility and access
  - Users must have VIEW_CHANNEL to see channels in lists, read messages, or interact with channels
  - Permission checks integrated across all major endpoints (22+ endpoints):
    - Search: Filters channels by VIEW_CHANNEL before searching messages
    - Channel retrieval: GET /api/channels/:id requires VIEW_CHANNEL
    - Message operations: List, create, edit, delete messages all require VIEW_CHANNEL
    - Reactions: Add, remove, and list reactions require VIEW_CHANNEL
    - Typing indicators: Both start and stop typing require VIEW_CHANNEL
    - Voice operations: Join requires VOICE_CONNECT, leave/mute require VIEW_CHANNEL
    - Screen sharing: Start requires SCREEN_SHARE permission
    - Favorites: Add/remove favorites requires VIEW_CHANNEL
  - Message sending also validates SEND_MESSAGES permission for guild channels
  - Voice channel join validates both VIEW_CHANNEL and VOICE_CONNECT permissions
  - Database migration adds VIEW_CHANNEL to all existing roles for backward compatibility
  - Channel permission overrides (allow/deny) fully supported for granular access control
  - DM channels remain accessible only to participants (no guild permissions apply)
  - Guild owners bypass all channel-level restrictions
  - Comprehensive integration tests (18 tests covering all permission scenarios)
  - Detailed documentation with mermaid diagrams (docs/features/channel-permissions.md)
- New `BLOCK_CHECK_FAIL_OPEN` configuration option for Redis block check behavior
  - When false (default, recommended): Block checks fail-closed, rejecting DMs/calls if Redis is unavailable (secure default)
  - When true: Block checks fail-open, allowing actions if Redis is unavailable (prioritizes availability over security)
  - Affects DM creation, DM message sending, call initiation, and call joining
  - Provides explicit control over availability vs security tradeoff during Redis outages
- PostgreSQL native full-text search for guild messages
  - Backend: tsvector column with GIN index for fast full-text search using `websearch_to_tsquery`
  - Backend: Guild-scoped search API with permission validation and pagination (`GET /api/guilds/:id/search`)
  - Backend: Bulk user/channel lookup optimization to prevent N+1 queries
  - Frontend: Search panel overlay with debounced input (300ms) and XSS-safe result highlighting
  - Frontend: Click-to-navigate to messages with highlight parameter support
  - Migration: `content_search` generated column with automatic updates on message edits
- Absolute user blocking with server-side enforcement
  - Block/unblock via context menu with confirmation modal
  - Blocked users cannot send DMs, friend requests, or initiate calls
  - Messages from blocked users are filtered in channel message lists
  - WebSocket events (typing, presence, messages) from blocked users are filtered in real-time
  - Redis SET-based block cache for low-latency enforcement
  - Block/unblock WebSocket events for instant client-side sync
- User reporting system
  - Users can report other users or specific messages (harassment, spam, inappropriate content, impersonation, other)
  - Rate-limited to 5 reports per hour, with duplicate prevention for active reports
  - Admin report queue with status/category filters and pagination
  - Admin actions: claim, resolve (dismiss/warn/ban/escalate)
  - Real-time admin notifications via WebSocket when new reports are created
  - Report statistics dashboard with counts by status
- Integration tests for blocking and reporting (25 tests)
  - 8 blocking tests: block/unblock, auth, self-block, prevents friend request/DM/message
  - 6 report tests: create, auth, self-report, invalid target/category, duplicate
  - 11 admin report tests: access control, list/filter, get, claim, resolve, stats
  - Shared test helpers: `create_friendship`, `create_dm_channel`, `create_elevated_session`, `create_test_report`
- Fixed friend list query bug where wrong column names prevented friends from loading
- SSO/OIDC authentication integration
  - Admin-configurable identity providers (GitHub, Google, custom OIDC/OAuth2)
  - PKCE S256 + state + nonce security for all flows
  - Client secrets encrypted at rest (AES-256-GCM)
  - Preset support for GitHub and Google with auto-filled endpoints
  - Admin settings panel for auth methods, registration policy, and provider CRUD
  - Login/Register views show SSO buttons when providers are configured
  - Registration policy enforcement (open, invite-only, closed)
  - Browser popup flow with postMessage token delivery
  - Username generation from OIDC claims with collision handling
- Screen share Tauri WebSocket event parity
  - ScreenShareStarted, ScreenShareStopped, ScreenShareQualityChanged variants in Tauri ServerEvent
  - Event forwarding to frontend via ws:screen_share_* events
- Screen share viewer keyboard shortcuts
  - Escape to close viewer, V to cycle view mode, M to toggle mute, F for spotlight/fullscreen
  - Input element guard to avoid conflicts when typing
- Screen share test coverage
  - Server event serialization tests (screenshare_test.rs)
  - Client WebSocket handler tests calling actual exported handlers (websocketScreenShare.test.ts)
- Component testing infrastructure for Solid.js
  - Vitest configuration with vite-plugin-solid
  - Test setup with automatic cleanup between tests
  - Initial tests for Skeleton and UnreadModule components
- Tauri WebSocket event parity improvements
  - Unread count tracking in Tauri mode (matches browser mode)
  - Voice event listeners for full voice chat support in Tauri
  - GitHub issue #132 filed to track 22 missing ServerEvent variants for full parity
- Global toast notifications for user feedback
  - Max 5 visible toasts with auto-dismiss of oldest
  - Error toasts for failed operations (message send, mark as read, etc.)
  - Success toasts for completed actions (avatar upload, settings saved, role/channel created)
- Content spoilers with `||text||` syntax for hiding sensitive information
  - Click-to-reveal functionality with persistent reveal state
  - Supports markdown and inline spoilers
  - ReDoS protection (500 character limit)
  - XSS prevention via DOMPurify allowlist
- @everyone and @here mention permission control
  - New MENTION_EVERYONE permission bit (bit 23) for guild roles
  - Server-side validation prevents unauthorized mass mentions
  - Permission UI toggle in guild role settings
  - Forbidden for @everyone role by default (moderator+ permission)
- Home page unread aggregator in modular sidebar
  - Centralized view of unread messages across all guilds and DMs
  - Grouped by guild with channel-level unread counts
  - Direct navigation to channels with unread messages
  - Comprehensive error handling with user-friendly toast notifications
  - Automatic refresh when window gains focus (throttled to 30s intervals)
  - WebSocket real-time updates with debounced refetch on new messages
  - Skeleton loading UI matching content layout
  - Collapsible module with unread badge
  - API endpoint: `GET /api/me/unread`
  - Performance-optimized database query with covering indexes
- First user setup wizard with automatic admin bootstrap
  - First user to register automatically receives system admin permissions
  - Mandatory setup wizard for configuring server name, registration policy, and legal URLs
  - Setup completion is permanent and cannot be re-triggered (prevents takeover)
  - Transaction-based race condition prevention for concurrent first-user registrations
  - Setup status exposed in authentication responses (`setup_required` flag)
  - API endpoints: `GET /api/setup/status`, `GET /api/setup/config`, `POST /api/setup/complete`
- Right-click context menus for messages, channels, and users
  - Message menu: Copy Text, Copy Message Link, Copy ID, Delete (own messages)
  - Channel menu: Mark as Read, Mute/Unmute, Add to Favorites, Edit Channel, Copy ID
  - User menu: View Profile, Send Message, Add Friend, Block, Copy User ID
  - Keyboard navigation with Arrow keys, Enter, Home/End, and Escape
- Custom avatars for DM and Group DM conversations (#104)
  - Click avatar in conversation header to upload custom icon
  - Avatars visible in sidebar and conversation header
  - Works for both 1:1 DMs and group DMs
- Custom display name for group DMs (#91)
  - PATCH `/api/dm/:id/name` endpoint to rename group DMs
  - Inline editing in conversation header (click group name to edit)
  - Real-time name sync via WebSocket `dm_name_updated` event
- Join Server button in server rail with invite code/link input modal
- Pixel art theme system with "Pixel Cozy" warm earth-tone theme
- Theme family architecture allowing community theme variants
- Structural CSS tokens (radii, fonts, shadows) for theme-aware UI
- Dithered texture patterns for pixel theme backgrounds
- Press Start 2P pixel font for UI elements
- Theme creation guide (THEME_GUIDE.md) for community contributors
- Cross-family fade transition when switching between theme types
- Theme consistency tests for validating theme definitions
- WebSocket notifications for friend requests
  - Real-time notification when receiving a friend request
  - Real-time notification when a friend request is accepted
- Profile update endpoint (`POST /auth/me`) for changing display_name and email
- Real-time state synchronization via WebSocket patch events
  - Incremental updates for users, guilds, and members (only changed fields sent)
  - Automatic subscription to guild event channels for member updates
  - Client-side patch handlers with field validation
- Fedora Atomic (Silverblue/Kinoite) support in development setup scripts
  - Automatic detection of immutable Fedora systems
  - Distrobox-based development container with all dependencies
  - Optional rpm-ostree layering fallback (with reboot requirement)
  - Export of development tools (cargo, bun, sqlx) to host `~/.local/bin`
  - Podman support alongside Docker for container orchestration
- Full-text message search using PostgreSQL tsvector
  - Search messages within a guild using `websearch_to_tsquery` syntax (supports AND, OR, quotes)
  - GIN index for fast search performance
  - Search panel in sidebar with debounced input (300ms)
  - Results show channel name, author, timestamp, and highlighted content preview
  - Click results to navigate directly to the message
  - Pagination support with "Load more" for large result sets
- Cross-server favorites: pin channels from different guilds into a unified Favorites section
  - Star icon on channels to toggle favorites (appears on hover, filled when favorited)
  - Expandable Favorites section in Sidebar grouped by guild
  - Click favorites to navigate directly to that guild and channel
  - Maximum 25 favorites per user
  - Automatic cleanup when last channel from a guild is unfavorited
- Modular Home Sidebar with collapsible modules:
  - Active Now module shows friends currently playing games
  - Pending module with quick accept/decline for friend requests
  - Pins module for saving notes and links across devices
  - Module collapse state syncs across all devices via server preferences
- Server-synced user preferences
  - Theme, sound settings, quiet hours, and per-channel notifications sync across all devices
  - Real-time updates via WebSocket when preferences change on another device
  - Offline support with automatic sync on reconnect
  - Migration from legacy localStorage keys
- Cross-client read sync for DMs
  - When reading a DM on one device, unread badges clear on all other devices instantly
  - Uses new `user:{user_id}` Valkey channel for user-targeted events
  - Real-time synchronization via WebSocket
- Unread message tracking for guild channels
  - Unread badge on text channels shows count of unread messages (capped at 99+)
  - Auto-marks channel as read after 1 second when viewing
  - Cross-device sync: reading on one device clears badges on all devices
  - Category headers indicate when any channel within has unread messages
- Do Not Disturb mode for notifications
  - Notification sounds suppressed when user status is "Do Not Disturb" (Busy)
  - Scheduled quiet hours with configurable start/end times
  - Handles overnight ranges (e.g., 22:00 to 08:00)
  - Call ring sounds also suppressed during DND
  - Quiet Hours settings UI in Settings > Notifications
- DM voice calls client integration
  - Voice connection wiring: WebRTC starts after accepting/starting calls
  - Tauri commands for call lifecycle (start, join, decline, leave)
  - Ring sound notification with looping playback for incoming calls
  - Call indicator in DM sidebar with pulsing animation for incoming calls
- Clipboard protection system for secure copy/paste operations
  - ClipboardGuard service with SHA-256 hash-based tamper detection
  - Auto-clear timers based on sensitivity (Critical: 60s, Sensitive: 120s)
  - Paranoid mode with 30s timeout for all sensitive content
  - Protection levels: Minimal, Standard, Strict (configurable in Settings)
  - UI components: ClipboardToast, ClipboardIndicator, TamperWarningModal
  - Browser fallback support when not running in Tauri
  - Integration with recovery phrase and invite link copying
- Sound notification system for chat messages
  - 5 notification sounds: Default, Subtle, Ping, Chime, Bell
  - Global notification settings in Settings > Notifications tab
  - Per-channel notification levels: All messages, Mentions only, or Muted
  - Volume control with test sound button
  - Smart playback with cooldown, tab leader election (web), and mention detection
  - Native audio playback via rodio in Tauri, Web Audio API fallback in browser
  - Muted channel indicator (bell-off icon) in channel list
- Home View Overhaul with "Friends First" design
  - Unified `HomeSidebar` replacing the legacy double-sidebar layout
  - Default "Friends" landing view with filter search (Online/All/Pending/Blocked)
  - "Active Now" panel showing real-time friend activity (games, voice, etc.)
  - Information section for server-wide pages (Rules, Announcements)
  - Collapsible Direct Messages list sorted by recent activity
- Custom Avatars system
  - `POST /auth/me/avatar` endpoint with S3 storage backend
  - "My Account" settings tab with avatar upload and preview
  - Client-side validation for image type and size (5MB limit)
  - Instant profile update propagation across the UI
- Status Picker in User Panel (Online, Away, Do Not Disturb, Invisible)
- Rich Presence (Game Activity) showing "Playing X" status in member lists
  - Automatic game detection via process scanning (sysinfo crate)
  - 15+ pre-configured games (Minecraft, Valorant, League of Legends, CS2, Fortnite, etc.)
  - Activity display in guild member list, friends list, and DM panels
  - Privacy toggle in settings to disable activity sharing
  - Real-time activity sync via WebSocket
- Screen sharing capability in browser clients with quality selection (480p/720p/1080p)
- Screen share button in voice controls with quality picker dialog
- Screen share indicator on participant avatars in voice panel
- WebSocket event handlers for screen share state synchronization
- User feature flags system for premium feature control (PREMIUM_VIDEO)
- Quality enum for screen share quality tiers (Low/Medium/High/Premium)
- User Connectivity Monitor for real-time voice connection quality tracking
  - Live quality indicators (latency, packet loss, jitter) in VoiceIsland and participant list
  - Toast notifications for connection issues (warning at 3% loss, critical at 7%)
  - Connection History page (`/settings/connection`) with 30-day analytics
  - TimescaleDB storage with automatic compression and 7-day retention
- E2EE key management with Olm protocol using vodozemac library
- Recovery key generation with Base58 display format for user backup
- Encrypted key backup with AES-256-GCM and Argon2id key derivation
- Multi-device support with per-device identity keys
- One-time prekey upload and atomic claiming for session establishment
- E2EE Key Backup UI with recovery key modal, security settings, and setup prompts
  - Recovery key modal with copy/download and confirmation flow
  - Security Settings tab showing backup status
  - Post-login E2EE setup prompt (skippable or mandatory via server config)
  - Backup reminder banner for users without backup
  - Server configuration option `REQUIRE_E2EE_SETUP` for mandatory setup
- End-to-End Encrypted DM messaging (Olm 1:1)
  - LocalKeyStore with encrypted SQLite storage for Olm accounts and sessions
  - CryptoManager for session management and encrypt/decrypt operations
  - Tauri commands for E2EE initialization, encryption, and decryption
  - E2EE store for frontend state management with Solid.js signals
  - E2EE setup modal with recovery key generation and secure clipboard integration
  - Encryption indicator (lock/unlock icon) in DM conversation headers
  - Graceful fallback to unencrypted messaging when E2EE not available
  - Automatic decryption of incoming encrypted messages
- Megolm group E2EE for group DM channels (3+ participants)
  - Megolm outbound/inbound sessions using vodozemac with pickle-based serialization
  - Session key distribution via 1:1 Olm-encrypted messages (automatic key exchange)
  - Session reuse with automatic rotation every 100 messages or on participant change
  - Automatic inbound session key processing â€” receivers store keys on receipt
  - `MegolmE2EEContent` message format distinguished from Olm via `megolm_ciphertext` field
  - LocalKeyStore persistence for Megolm sessions (encrypted SQLite via SQLCipher)
  - Tauri IPC commands: `create_megolm_session`, `encrypt_group_message`, `add_inbound_group_session`, `decrypt_group_message`
  - Frontend E2EE store with `createGroupSession`, `encryptGroup`, `decryptGroup`, `addInboundSession`
  - Transparent routing: group DMs automatically use Megolm, 1:1 DMs use Olm
- Information Pages system for platform-wide and guild-specific content (ToS, Privacy Policy, FAQ, rules, guides)
- Markdown editor with live preview, toolbar, and cheat sheet
- Mermaid diagram support in markdown preview
- Page acceptance tracking with scroll-to-bottom requirement for mandatory pages
- Page ordering via drag-and-drop with position persistence
- Audit logging for all page operations (create, update, delete, reorder)
- CHANGELOG.md following keepachangelog.com format
- Changelog maintenance guidelines in CLAUDE.md
- Admin Dashboard with user management, guild oversight, and audit log viewing
- AdminQuickModal for quick admin access with elevation status and stats
- Session elevation system with MFA verification and 15-minute expiry
- Ban/unban users and suspend/unsuspend guilds (requires elevation)
- Admin panel Phase 1 improvements
  - User avatars and guild icons displayed in admin lists
  - Skeleton loading animations replacing text placeholders
  - Keyboard navigation (Arrow keys, Enter, Escape) in user/guild tables
- Admin panel Phase 2 improvements
  - Server-side search for users (by username, display name, email) and guilds (by name)
  - Debounced search input with 300ms delay for reduced API calls
  - Audit log advanced filters: date range picker and action type dropdown
  - Active filter indicators showing current filter state
- Admin panel Phase 3 improvements
  - User detail expansion showing last login, guild count, and guild memberships
  - Guild member preview with owner info and stacked avatar display of top members
  - Lazy-loaded detail panels to reduce initial load time
- Admin panel Phase 4 improvements
  - CSV export for users and guilds with current search/filter applied
  - Bulk ban users with checkbox selection and confirmation dialog
  - Bulk suspend guilds with multi-select and reason input
  - Select all / clear selection controls in bulk action bar
- Admin panel Phase 5 improvements
  - Real-time updates via WebSocket for admin actions (ban/unban, suspend/unsuspend)
  - Undo functionality with toast notifications for ban and suspend actions (5-second window)
  - Toast action buttons for immediate undo capability
  - Admin event subscription for elevated admins
- Screen share viewer with three view modes (Spotlight, PiP, Theater)
- Volume control for screen share audio
- Screen share list in voice panel showing active shares
- Click-to-view screen shares from participant indicators
- Voice quality indicators with real-time latency, packet loss, and jitter display
- Accessibility shapes (circle/triangle/hexagon) for colorblind-friendly status indicators
- User status picker with Online, Idle, Do Not Disturb, and Invisible options
- Custom status with emoji and auto-expiry timer
- Automatic idle detection after configurable inactivity timeout
- Message reactions with emoji picker
- Emoji search, recent emojis, and favorites support
- Guild custom emoji database schema and API
- Channel categories with 2-level folder hierarchy
- Collapsible category headers with unread indicators
- Drag-and-drop reordering for channels and categories
- Display preferences for indicator modes (dense/minimal/discord)
- Guild Emoji Manager
  - Custom guild emoji support with `MANAGE_EMOJIS_AND_STICKERS` permission
  - Animated emoji support (GIF, WebP)
  - Drag-and-drop upload in Guild Settings > Emojis tab
  - Bulk upload utility script (`scripts/upload_emojis.py`)
- Configurable file size limits for different upload types
  - `MAX_AVATAR_SIZE` environment variable for user and DM avatars (default: 5MB)
  - `MAX_EMOJI_SIZE` environment variable for guild custom emojis (default: 256KB)
  - `MAX_UPLOAD_SIZE` for message attachments (default: 50MB)
- Frontend validation helper function (`validateFileSize()`) for instant user feedback before upload
- User-friendly error messages showing both file size and limit in human-readable format (KB/MB)

### Changed
- Upgraded message list virtualizer from custom implementation to `@tanstack/solid-virtual` for proper dynamic sizing via ResizeObserver
- Replaced MinIO (AGPL-3.0) with RustFS (Apache-2.0) as the default S3-compatible object storage for development â€” no code changes needed, only Docker and documentation updates
- Bot command responses now enforce single-response semantics â€” each `interaction_id` accepts exactly one `CommandResponse`, duplicate responses are rejected with a clear error (#176)
- Guild channel permission checks in search and channel listing are now batched â€” fetches membership, roles, and channel overrides in ~4 queries total instead of 5 per channel, reducing database round-trips from 5N to constant for N-channel guilds (#181)
- Dynamic SQL query construction now uses `sqlx::QueryBuilder` instead of manual `format!()`/`write!()` with parameter index tracking, eliminating a class of potential runtime parameter mismatch errors (#174)
- Search results now display server-generated highlighted snippets instead of client-side regex matching
- Thread participant avatars â€” ThreadIndicator shows small overlapping avatar thumbnails of the most recent thread participants
- Thread unread indicator â€” blue dot and bold text on threads with unread replies, clears when thread is opened or marked as read
- #channel autocomplete â€” type `#` in guild channels to mention text channels with fuzzy matching
- /command autocomplete â€” type `/` at the start of a message to browse available slash commands from installed bots
- Reaction keyboard shortcuts â€” press Alt+1 through Alt+4 while hovering a message to quick-react (ðŸ‘, â¤ï¸, ðŸ˜‚, ðŸ˜®)
- Guild commands API endpoint (`GET /api/guilds/{id}/commands`) listing available slash commands from installed bots
- Bot token format changed to "bot_user_id.secret" for indexed authentication (breaking change for existing bots)
- Documentation audit and cleanup
  - Updated all version numbers in standards.md to match actual dependencies
  - Updated project specification status to Phase 4
  - Fixed architecture diagrams (removed mediasoup, nnnoiseless references)
  - Removed resolved tech debt and stale persona review sections from architecture overview
  - Fixed broken internal documentation links across all docs
- Upgraded vite-plugin-solid to 2.11.10 for vitest 4 compatibility
- Upgraded vite to 7.3.1 for better tooling compatibility
- Native screen capture for Tauri desktop client
  - Source picker modal to select monitors or windows
  - VP9 software encoding with quality tiers (480p15 to 1080p60)
  - RTP packetization and delivery via WebRTC video track
  - Quality picker with low/medium/high/premium presets
  - Auto-stop screen share when leaving voice channel
  - Cross-platform via scap (ScreenCaptureKit, WGC, PipeWire)
- Forgot password workflow with SMTP email delivery
  - POST /auth/forgot-password â€” request reset code via email
  - POST /auth/reset-password â€” reset password with code
  - SMTP configuration (SMTP_HOST, SMTP_USERNAME, SMTP_PASSWORD, SMTP_FROM, SMTP_TLS)
  - Rate-limited endpoints (AuthPasswordReset category)
  - All sessions invalidated on successful password reset
  - No user enumeration (generic responses for unknown emails)
  - Frontend pages: /forgot-password and /reset-password
  - Background cleanup for expired reset tokens
- Modernized dependencies across all workspace crates
  - axum 0.7â†’0.8, tower 0.4â†’0.5, tower-http 0.5â†’0.6, utoipa 4â†’5
  - fred 8â†’10 (Redis client), reqwest 0.11â†’0.13
  - vodozemac 0.5â†’0.9 (E2EE crypto)
  - cpal 0.15â†’0.17, rodio 0.19â†’0.21 (audio)
  - sysinfo 0.30â†’0.34 (game detection)
  - sqlx 0.7â†’0.8.6, rusqlite 0.29â†’0.32 (database)
  - thiserror 1â†’2, validator 0.16â†’0.20, pulldown-cmark 0.10â†’0.13
  - Removed unused x25519-dalek and ed25519-dalek crates
- **BREAKING:** Authentication responses now include `setup_required` boolean field
  - Affects `POST /auth/register`, `POST /auth/login`, and `POST /auth/refresh` endpoints
  - Existing clients must handle the new field or update their deserialization logic
  - Field indicates whether server setup wizard should be displayed
- JWT signing algorithm upgraded from HS256 â†’ EdDSA (Ed25519) for stronger cryptographic security
- Infrastructure: Redis replaced with Valkey for open-source compatibility
- API error response format standardized across all endpoints (consistent error codes)
- Health endpoint now verifies database and Redis connectivity (returns "degraded" status on failure)
- Consolidated ThemeName type to single source of truth in types.ts
- UnoCSS theme config now uses CSS custom properties for border-radius and shadows
- StatusIndicator component now uses SVG shapes instead of colored dots
- UserStatus type extended from 4 to 5 statuses (added 'dnd')
- Improved UI contrast and accessibility
  - Fixed unreadable text in selected Settings tabs (high contrast text)
  - Updated error banners to use semantic theme tokens for better visibility
  - Added clearer separator lines in sidebars for visual hierarchy
  - Increased border visibility to `border-white/10` for main layout framing
- DM group avatar size limit reduced from 50MB to 5MB for consistency with user avatars
- Guild custom emoji size limit is now configurable (previously hardcoded at 256KB)
- Updated dependencies for compatibility and performance:
  - tokio-tungstenite 0.21 â†’ 0.28 (WebSocket improvements)
  - reqwest: migrated from deprecated `rustls-tls` to `rustls` feature
  - Fixed breaking changes in tungstenite 0.28 Message::Text API
- Conducted comprehensive dependency audit (45+ dependencies reviewed)
  - Identified critical updates (sqlx, axum) and blockers
  - Phased update strategy executed in subsequent releases

### Deprecated

### Removed
- Deleted 12 stale documentation files (session artifacts, redundant license docs, completed update checklists, dependency snapshots)
- Removed phantom dependencies from standards documentation (jsonrpsee, nnnoiseless, metrics, x25519-dalek, ed25519-dalek)
- Removed stale scripts (resume-session.sh, update-deps.sh)
- Legacy unscoped `GET /api/channels` endpoint that returned all channels across all guilds

### Fixed
- Message list layout drift when images load or code blocks expand â€” now uses real element measurement instead of estimated sizes
- Toast notifications now use consistent durations (error: 8s, success: 3s) and dedup IDs for repeatable events (command timeout, screen share)
- Slash command autocomplete now allows hyphens in command names
- Guild command listing shows all providers instead of silently deduplicating â€” fixes inconsistency where autocomplete showed one bot but invocation picked a different one
- Ambiguity errors now include conflicting bot names for easier disambiguation
- Slash command fetch retry no longer locks out permanently on failure
- E2E tests no longer silently pass without assertions â€” eliminated 97 anti-pattern instances across 10 spec files: `.catch(() => false)` guards converted to hard `expect()` assertions, `waitForTimeout()` calls replaced with deterministic waits, duplicate `login()` with wrong default password removed from `permissions.spec.ts` (#186)
- `get_page_by_id` now filters soft-deleted pages (`deleted_at IS NULL`), preventing operations on deleted pages
- `reorder_pages` wrapped in database transaction to prevent partial reorder on failure, with duplicate page ID validation
- Page acceptance endpoint now validates `requires_acceptance` flag before recording acceptance
- Guild-scoped page acceptance endpoint added â€” guild pages are accepted via `/guilds/{id}/pages/{id}/accept`
- Silent audit log failures (`.ok()`) replaced with explicit error logging across all page handlers
- Silent `unwrap_or` in slug/limit checks replaced with `unwrap_or_else` + error logging in page creation/update handlers
- `PlatformPagesCard` and `PageSection` components now use reactive `<Show>` wrappers instead of non-reactive early returns
- `PlatformPagesCard` now displays error state when page loading fails instead of rendering empty
- `AcceptanceManager` now checks `acceptPage` return value and surfaces acceptance failures to the user
- `AcceptanceManager` shows blocking error overlay when a required platform page fails to load (instead of silently skipping)
- `AcceptanceManager.handleDefer` now properly awaits async `showNextPage()` call
- `PageAcceptanceModal` resets `isAccepting` state in `finally` block, preventing stuck "Accepting..." button on error
- `PageAcceptanceModal` re-checks scroll height after markdown rendering completes, fixing premature "scroll to bottom" requirement
- `PageAcceptanceModal` adds `role="dialog"` and `aria-modal` for accessibility
- `PageView.handleDelete` now catches and displays delete errors instead of failing silently
- `PageEditor` syncs form signals when `props.page` changes, fixing stale form data when navigating between pages
- Client `MAX_PAGES_PER_SCOPE` constant corrected from 50 to 10 to match server
- Password reset views now read server URL from localStorage, matching Login/Register behavior for self-hosted setups
- Server URL forwarded from Forgot Password to Reset Password page via query parameter
- Forgot Password and Reset Password form labels now linked to inputs via `for`/`id` for accessibility
- Error messages on password reset forms announced to screen readers via `role="alert"`
- Typed error handling (`err: unknown` + `instanceof Error`) in password reset forms instead of `catch(err: any)`
- Expired reset token cleanup query now logs database errors instead of silently propagating
- Content spoilers (`||text||`) now render correctly â€” DOMPurify config was stripping spoiler HTML tags
- Mention highlighting no longer corrupts inline code spans (e.g. `` `@everyone` `` renders correctly)
- Mention styling no longer bleeds through unrevealed spoiler overlays
- Reaction add/remove errors now show toast notifications instead of failing silently
- Command Palette mute/deafen commands now toggle microphone and deafen state instead of logging to console
- "Delete Message" context menu action now calls the server API with confirmation dialog
- "Mark as Read" channel context menu action now clears unread state via `markChannelAsRead`
- "Mute/Unmute Channel" context menu action now toggles notification level via preferences store
- "View Profile" and "Send Message" user context menu actions now navigate to or create a DM conversation
- "Add Friend" user context menu action now sends a friend request
- SearchPanel TypeScript compilation errors (type mismatch in `handleResultClick` signature)
- Message edit WebSocket events now update message content in real-time instead of only logging
- Presence update WebSocket events now update user online/offline status instead of only logging
- Missing Tauri listeners for `admin_user_deleted` and `admin_guild_deleted` events
- Missing `GuildEmojiUpdated` WebSocket handler in both browser and Tauri mode
- Missing Tauri backend event forwarding for `GuildEmojiUpdated`, `AdminUserDeleted`, `AdminGuildDeleted`, `WebcamStarted`, `WebcamStopped`
- Dead "Learn more" link (`href="#"`) in clipboard tamper warning modal replaced with informational text
- Non-interactive guild header in sidebar had misleading cursor-pointer styling
- Admin shield button in UserPanel now opens the AdminQuickModal instead of navigating directly (modal was unreachable dead code)
- Channel permission overrides now show only channel-relevant permissions
  - Added `View Channel` to channel override controls so visibility can be managed explicitly
  - Removed guild-level permission toggles from the channel override editor to reduce confusing options
- Member moderation controls now appear for users who can kick but cannot manage roles
  - The member "Manage" dropdown is shown when you have kick authority over a target based on role hierarchy
  - Role assignment controls stay hidden unless you have `MANAGE_ROLES`, reducing confusing disabled actions
- Windows Tauri build failure caused by `scap` screen capture dependency (upgraded to v0.1.0-beta.1 with patched Linux PipeWire engine)
- CI pipeline failures: disk space exhaustion in security test, Docker build for shared crate structure, and Tauri bundling missing icon
- Voice island visibility and contrast issues (#151)
  - Disconnect button now uses higher contrast background and white icon for better visibility
  - Drag handle opacity increased from 40% to 60%
  - Connection status dot enlarged and changed to green with subtle glow
  - Quality indicator now uses theme colors instead of hardcoded values
- Favorite star button not responding to clicks in channel list (#152)
  - Fixed invalid nested `<button>` HTML structure in ChannelItem that prevented click events from reaching the star toggle
  - Converted outer channel button to a `<div>` with proper `role="button"` and keyboard accessibility
- Avatar and file uploads in Tauri desktop app (#150)
  - Added `get_auth_info` Tauri command to expose auth credentials to the webview
  - Upload functions now properly retrieve auth token and server URL in Tauri mode
  - Also fixes file attachment and emoji uploads in the desktop client
- Volume slider now controls notification sound volume in Tauri desktop app (#146)
  - Tauri `play_sound` command now accepts and applies volume setting
  - Both notification playback and test sound respect the volume slider
- Screen share volume slider thumb now visible and interactive (#146)
  - Added proper CSS pseudo-selectors for the range input thumb
- Sound notification testing now plays audio in browser/webview mode (#145)
  - Added missing sound .wav files to `public/sounds/` for static serving
  - Previously only embedded in Tauri binary, causing 404 for browser fetch
- Potential message loss when WebSocket message arrives during pagination load
  - `addMessage` now re-reads store state after async decryption to avoid overwriting concurrent prepends
- File attachment uploads in text chat (#149)
  - Fixed AWS SDK panic when initializing S3 client (missing tokio sleep implementation)
  - Object storage bucket now automatically initialized in development environment
  - Added comprehensive file uploads documentation (docs/development/file-uploads.md)
  - Added storage initialization script (scripts/init-rustfs.sh)
  - Updated setup guide with file upload configuration steps
- Clippy warnings in crypto and server modules
  - Suppress false-positive `missing_const_for_fn` lint in vc-crypto
  - Fix `many_single_char_names` in BGRAâ†’I420 color conversion
  - Remove unnecessary raw string hashes in SQL queries
- Screen share quality tier now rejects invalid values instead of silently defaulting to "medium"
- Eliminated redundant screen capture source lookup (was querying all targets twice per share start)
- Encoder shutdown now responds promptly to stop signal instead of blocking on next frame
- Removed unused RTP sequence tracking (handled by webrtc-rs internally)
- Pre-allocated I420 buffer in VP9 encoder to avoid per-frame heap allocation
- Emoji picker positioning and viewport clipping issues
  - Integrated @floating-ui/dom for smart positioning that adapts to available space
  - Picker now automatically flips up/down and shifts left/right to stay visible
  - Dynamic max-height adjustment based on viewport size
  - Click-outside and Escape key support for better UX
  - Portal-based rendering prevents clipping by parent containers
  - Smooth fade-in animation when picker appears
- Friend requests failing in desktop client (#107)
  - Removed dead Tauri `invoke()` branches for friend commands (no corresponding Rust commands existed)
  - All friend operations now use HTTP API consistently
- DM avatar upload now works in desktop client and updates reactively (#104)
- DM list now shows online status for 1:1 conversations using presence store
- Kick member button now properly checks KICK_MEMBERS permission
- Voice session finalization with retry logic for reliability
- Redis broadcast failures now logged instead of silently ignored
- VoiceStatsLimiter periodic cleanup prevents memory leaks
- Admin elevated session cache falls back to database on cache miss
- Pixel font rendering fixed (blurry text in pixel themes)
- Reaction API endpoints corrected with proper WebSocket handlers
- Message pagination cursor comparison corrected for stable ordering
- Server build failure fixed by adding `Deserialize` to `GuildEmoji`
- **Fixed**: Pinned notes functionality restored (fixed API wrapper implementation) (#105)
- Documentation formatting in admin handlers fixed
- Orphaned password reset tokens cleaned up when email send fails (#130)
- Removed unused `update_user_password` database function (#131)

### Security
- Megolm group E2EE stubs gated behind compile-time `megolm` feature flag â€” previously contained `todo!()` macros that would panic at runtime if group encryption was invoked (TD-01)
- Search query length capped at 1000 characters across guild, DM, and global search endpoints to prevent resource exhaustion (TD-08)
- Eliminated all `.unwrap()` calls in production server code â€” TOTP secret decoding now returns proper errors instead of panicking, WebSocket auth responses use `.expect()` with justification, duration arithmetic uses `saturating_sub()`, and S3 endpoint formatting uses safe `if let` pattern (#163)
- File upload magic byte validation â€” uploaded files are now verified against their claimed MIME type using content inspection, preventing file type spoofing (e.g. executables disguised as images)
- Password reset endpoint no longer leaks user existence via HTTP 500 on database errors â€” all code paths now return generic 200
- Password reset aborts if old token invalidation fails, preventing token accumulation
- SMTP connection verified at server startup; misconfiguration logged at error level instead of warn
- Page handlers no longer leak database schema details in error responses â€” all internal errors logged server-side, generic message returned to client
- DOMPurify configuration no longer uses global `setConfig()` â€” inline config prevents cross-component state pollution
- Mermaid SVG sanitization uses explicit `ALLOWED_TAGS` allowlist instead of additive `ADD_TAGS`, preventing HTML tag leakage into SVG context
- DOMPurify class attribute allowlist prevents CSS-based UI spoofing via arbitrary class injection in messages
- Encrypted messages are now excluded from all search results
- Fixed O(n) authentication DoS vulnerability in bot token verification (now uses indexed lookup)
- Fixed TOCTOU race condition in bot user creation (moved check inside transaction with FOR UPDATE lock)
- Fixed TOCTOU race condition in bot token reset (added transaction with FOR UPDATE lock)
- Replaced weak UUID salt with proper CSPRNG (SaltString + OsRng) for Argon2 password hashing
- Added channel membership authorization for bot message creation
- Added content length validation for command responses to prevent Redis exhaustion
- Added inbound bot gateway rate limiting to reduce abuse risk from compromised bot tokens
- Bound command response interactions to the invoking bot identity before accepting responses
- Fixed channel permission bypass in favorites endpoint
  - Add favorite (POST /api/me/favorites/:channel_id) now validates VIEW_CHANNEL permission
  - Previously only checked guild membership, allowing users to favorite channels they couldn't view
  - Fixes potential information disclosure where channel existence could be inferred without proper access
- **CRITICAL FIX**: WebSocket event filtering race condition that could allow blocked users' messages to leak through
  - Replaced `try_read()` with `blocking_read()` in WebSocket event filtering for messages, typing indicators, voice events, and presence updates
  - Previous implementation used `try_read().map(...).unwrap_or(false)` which would fail open on lock contention, allowing blocked users' events through
  - Fix ensures block checks never fail open - will wait for lock rather than returning false on contention
  - Affects MessageNew, TypingStart, TypingStop, VoiceUserJoined, VoiceUserLeft, CallParticipantJoined, CallParticipantLeft, PresenceUpdate, and RichPresenceUpdate events
- Attachment access now enforces guild/DM membership (previously any authenticated user could access any file)
- CORS hardened with configurable origins for production (development mode allows any origin)
- Request-ID header propagation for security tracing and correlation
- MFA verification enforced during login flow
- Markdown HTML output sanitized with DOMPurify to prevent XSS
- Prevented `@everyone` role from being assigned dangerous permissions (e.g., `MANAGE_GUILD`, `BAN_MEMBERS`) via API validation
- XSS hardening for Mermaid SVG rendering (forbid foreignObject, style, script tags)
- Ownership verification in page reorder operations prevents cross-guild attacks
- Fail-fast permission checks on database errors (no silent auth bypass)
- Fixed missing size validation for user avatar uploads (previously relied only on DefaultBodyLimit middleware)

## [0.1.0] - 2026-01-18

### Added
- Permission system with API handlers for admin, roles, and overrides
- Rate limiting middleware with Redis-based tracking and route integration
- Hierarchical AGENTS.md documentation for codebase navigation
- Git workflow design with commit conventions and worktree strategy
- Docker-based test infrastructure with proper database permissions
- Admin panel with two-tier privilege model (base admin + elevated admin)
- System audit logging for compliance and security tracing
- Global user bans and guild suspension capabilities
- System announcements feature

### Changed
- Hardened Docker infrastructure with Bitnami images
- Reworked persona system to concern-based code reviews
- Updated roadmap with Phase 3 status (rate limiting complete)

### Fixed
- File upload and download issues
- Merge conflict resolution from cherry-pick
- Dockerfile path reference in CI workflow
- MinIO image configuration (switched to official minio/minio)
- Bitnami images using :latest tag
- Secondary sort key for stable message ordering
- SQLx test fixtures with proper db permissions
- Code formatting and clippy warnings

[Unreleased]: https://github.com/Wolftown-io/canis/compare/v0.1.0...HEAD
[0.1.0]: https://github.com/Wolftown-io/canis/releases/tag/v0.1.0
