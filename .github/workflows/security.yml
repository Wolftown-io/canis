name: Security Audit

on:
  # Run weekly on Sundays at midnight UTC
  schedule:
    - cron: '0 0 * * 0'
  # Allow manual triggering
  workflow_dispatch:
  # Run on pushes to main (for critical security updates)
  push:
    branches: [main]
    paths:
      - 'Cargo.lock'
      - 'client/bun.lock'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ===========================================================================
  # Rust Security Audit
  # ===========================================================================
  rust-audit:
    name: Rust Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit
        # NOTE: Keep --ignore list in sync with deny.toml [advisories].ignore
        run: >-
          cargo audit
          --ignore RUSTSEC-2025-0008
          --ignore RUSTSEC-2023-0071
          --ignore RUSTSEC-2026-0002

      - name: Check for yanked crates
        run: cargo audit --deny yanked

  # ===========================================================================
  # Dependency Vulnerability Scan
  # ===========================================================================
  dependencies:
    name: Dependency Check (cargo-deny)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Check advisories
        run: cargo deny check advisories

      - name: Check licenses
        run: cargo deny check licenses

      - name: Check bans
        run: cargo deny check bans

  # ===========================================================================
  # Frontend Security Audit
  # ===========================================================================
  bun-audit:
    name: Bun Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3"

      - name: Install dependencies
        run: bun install --frozen-lockfile || (sleep 5 && bun install --frozen-lockfile)

      - name: Run bun audit
        run: bun pm audit

  # ===========================================================================
  # Secrets Scanning
  # ===========================================================================
  secrets-scan:
    name: Secrets Scanning (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for Gitleaks Pro

  # ===========================================================================
  # SAST (Static Application Security Testing)
  # ===========================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      matrix:
        language: ['javascript', 'typescript']
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
