# VoiceChat Production Docker Compose
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. docker compose up -d
#
# Required environment variables (see .env.example):
#   - DOMAIN: Your domain (e.g., chat.example.com)
#   - POSTGRES_PASSWORD: Strong database password
#   - JWT_SECRET: Strong secret for JWT signing
#   - ACME_EMAIL: Email for Let's Encrypt certificates

services:
  # ==========================================================================
  # VoiceChat Server
  # ==========================================================================
  server:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: voicechat/server:latest
    container_name: canis-server
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
    environment:
      - BIND_ADDRESS=0.0.0.0:8080
      - DATABASE_URL=postgres://voicechat:${POSTGRES_PASSWORD}@postgres:5432/voicechat
      - REDIS_URL=redis://valkey:6379
      - JWT_SECRET=${JWT_SECRET}
      - S3_ENDPOINT=${S3_ENDPOINT:-}
      - S3_BUCKET=${S3_BUCKET:-voicechat}
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - STUN_SERVER=${STUN_SERVER:-stun:stun.l.google.com:19302}
      - TURN_SERVER=${TURN_SERVER:-}
      - TURN_USERNAME=${TURN_USERNAME:-}
      - TURN_CREDENTIAL=${TURN_CREDENTIAL:-}
      - MFA_ENCRYPTION_KEY=${MFA_ENCRYPTION_KEY:-}
      # Rate limiting
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_TRUST_PROXY=${RATE_LIMIT_TRUST_PROXY:-true}
      - RATE_LIMIT_ALLOWLIST=${RATE_LIMIT_ALLOWLIST:-}
    ports:
      # WebRTC UDP ports for voice
      - "${RTP_PORT_MIN:-10000}-${RTP_PORT_MAX:-10100}:${RTP_PORT_MIN:-10000}-${RTP_PORT_MAX:-10100}/udp"
    networks:
      - voicechat
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.voicechat.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.voicechat.entrypoints=websecure"
      - "traefik.http.routers.voicechat.tls.certresolver=letsencrypt"
      - "traefik.http.services.voicechat.loadbalancer.server.port=8080"
      # WebSocket support
      - "traefik.http.middlewares.voicechat-ws.headers.customrequestheaders.Connection=Upgrade"

  # ==========================================================================
  # PostgreSQL Database (Bitnami hardened image)
  # ==========================================================================
  postgres:
    image: bitnami/postgresql:latest
    container_name: canis-postgres
    restart: unless-stopped
    environment:
      - POSTGRESQL_USERNAME=voicechat
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRESQL_DATABASE=voicechat
    volumes:
      - postgres_data:/bitnami/postgresql
    networks:
      - voicechat
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U voicechat -d voicechat"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Valkey (Redis-compatible, BSD-3-Clause licensed)
  # ==========================================================================
  valkey:
    image: bitnami/valkey:latest
    container_name: canis-valkey
    restart: unless-stopped
    environment:
      - VALKEY_PASSWORD=${VALKEY_PASSWORD:-}
      - ALLOW_EMPTY_PASSWORD=${ALLOW_EMPTY_PASSWORD:-no}
    volumes:
      - valkey_data:/bitnami/valkey/data
    networks:
      - voicechat
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Traefik Reverse Proxy
  # ==========================================================================
  traefik:
    image: traefik:v3.0
    container_name: canis-traefik
    restart: unless-stopped
    command:
      - "--api.dashboard=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - letsencrypt:/letsencrypt
    networks:
      - voicechat

networks:
  voicechat:
    driver: bridge

volumes:
  postgres_data:
  valkey_data:
  letsencrypt:
